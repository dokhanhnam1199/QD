import numpy as np
import random

def heuristics_v2(distance_matrix, coordinates, demands, capacity):
    """{This algorithm constructs routes using a savings-based approach, iteratively merging routes based on the savings gained by connecting their end nodes, and penalizes edges that violate capacity constraints by reducing their heuristic values.}"""

    n = len(demands)
    heuristics_matrix = np.zeros((n, n))
    
    # Initialize savings matrix
    savings = np.zeros((n, n))
    for i in range(1, n):
        for j in range(i+1, n):
            savings[i, j] = distance_matrix[0, i] + distance_matrix[0, j] - distance_matrix[i, j]
            savings[j, i] = savings[i, j]  # Savings are symmetric

    # Initialize individual routes for each customer
    routes = [[i] for i in range(1, n)]
    route_demands = {i: demands[i] for i in range(1, n)}
    
    num_iterations = 1000
    for _ in range(num_iterations):
        # Find the best savings
        best_savings = -1
        best_i = -1
        best_j = -1

        for i in range(1, n):
            for j in range(i + 1, n):
                if savings[i, j] > best_savings:
                    # Check if i and j are end nodes of different routes
                    route_i = None
                    route_j = None
                    for r_idx, route in enumerate(routes):
                        if route[0] == i:
                            route_i = r_idx
                        if route[-1] == j:
                            route_j = r_idx
                    
                    if route_i is not None and route_j is not None and route_i != route_j:
                        best_savings = savings[i, j]
                        best_i = i
                        best_j = j
                        best_route_i = route_i
                        best_route_j = route_j
        # Merge routes if beneficial and feasible
        if best_savings > 0:
            
            route_i = routes[best_route_i]
            route_j = routes[best_route_j]
            
            total_demand = sum([demands[node] for node in route_i + route_j])
            
            if total_demand <= capacity:
                
                
                for node1 in route_i:
                  for node2 in route_j:
                    heuristics_matrix[node1, node2] +=1
                    heuristics_matrix[node2, node1] +=1
                # Merge the routes
                routes[best_route_i] = route_i + route_j
                del routes[best_route_j]

    return heuristics_matrix
